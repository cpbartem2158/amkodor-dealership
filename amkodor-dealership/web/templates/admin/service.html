<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–∏—Å - –ê–º–∫–æ–¥–æ—Ä</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
<div class="admin-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>–ê–ú–ö–û–î–û–†</h2>
            <p>–ê–≤—Ç–æ—Å–∞–ª–æ–Ω</p>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <span class="icon">üìä</span>
                –î–∞—à–±–æ—Ä–¥
            </a>
            <a href="/admin/vehicles" class="nav-item">
                <span class="icon">üöú</span>
                –¢–µ—Ö–Ω–∏–∫–∞
            </a>
            <a href="/admin/sales" class="nav-item">
                <span class="icon">üí∞</span>
                –ü—Ä–æ–¥–∞–∂–∏
            </a>
            <a href="/admin/customers" class="nav-item">
                <span class="icon">üë•</span>
                –ö–ª–∏–µ–Ω—Ç—ã
            </a>
            <a href="/admin/employees" class="nav-item">
                <span class="icon">üëî</span>
                –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
            </a>
            <a href="/admin/service" class="nav-item active">
                <span class="icon">üîß</span>
                –°–µ—Ä–≤–∏—Å
            </a>
            <a href="/admin/reports" class="nav-item">
                <span class="icon">üìà</span>
                –û—Ç—á–µ—Ç—ã
            </a>
        </nav>
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <h1>–°–µ—Ä–≤–∏—Å–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
            <div>
                <button onclick="switchTab('orders')" id="btnOrders" class="btn btn-primary">–ó–∞–∫–∞–∑—ã</button>
                <button onclick="switchTab('testdrives')" id="btnTestDrives" class="btn btn-secondary">–¢–µ—Å—Ç-–¥—Ä–∞–π–≤—ã</button>
                <button onclick="switchTab('parts')" id="btnParts" class="btn btn-secondary">–ó–∞–ø—á–∞—Å—Ç–∏</button>
            </div>
        </header>

        <!-- –°–µ—Ä–≤–∏—Å–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
        <section id="ordersTab" class="table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>–°–µ—Ä–≤–∏—Å–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
                <button onclick="createOrder()" class="btn btn-primary">+ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–¢–µ—Ö–Ω–∏–∫–∞</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–¢–∏–ø —Ä–∞–±–æ—Ç</th>
                    <th>–ú–∞—Å—Ç–µ—Ä</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="ordersTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>

        <!-- –¢–µ—Å—Ç-–¥—Ä–∞–π–≤—ã -->
        <section id="testdrivesTab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>–¢–µ—Å—Ç-–¥—Ä–∞–π–≤—ã</h3>
                <button onclick="createTestDrive()" class="btn btn-primary">+ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                    <th>–ú–æ–¥–µ–ª—å</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                    <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–û—Ü–µ–Ω–∫–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="testdrivesTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>

        <!-- –ó–∞–ø—á–∞—Å—Ç–∏ -->
        <section id="partsTab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
                <button onclick="createPart()" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ú–æ–¥–µ–ª—å</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–ú–∏–Ω–∏–º—É–º</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–∫–ª–∞–¥</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="partsTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>
    </main>
</div>

<script src="/static/js/api.js"></script>
<script>
    let currentTab = 'orders';

    async function loadServiceOrders() {
        try {
            const orders = await API.service.getAllOrders({ limit: 50 });
            displayOrders(orders);
        } catch (error) {
            console.error('Error loading orders:', error);
        }
    }

    async function loadTestDrives() {
        try {
            const testDrives = await API.testDrives.getAll({ limit: 50 });
            displayTestDrives(testDrives);
        } catch (error) {
            console.error('Error loading test drives:', error);
        }
    }

    async function loadParts() {
        try {
            const parts = await API.service.getAllParts({ limit: 100 });
            displayParts(parts);
        } catch (error) {
            console.error('Error loading parts:', error);
        }
    }

    function displayOrders(orders) {
        const tbody = document.getElementById('ordersTable');

        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = orders.map(o => `
                <tr>
                    <td>${o.service_order_id}</td>
                    <td>${formatDate(o.order_date)}</td>
                    <td>${o.model_name || '-'}</td>
                    <td>${o.client_name || '-'}</td>
                    <td>${o.service_type}</td>
                    <td>${o.master_name || '-'}</td>
                    <td>${formatCurrency(o.cost)}</td>
                    <td><span class="badge badge-${getStatusColor(o.status)}">${o.status}</span></td>
                    <td>
                        <button onclick="viewOrder(${o.service_order_id})" class="btn-icon">üëÅÔ∏è</button>
                        ${o.status === '–í —Ä–∞–±–æ—Ç–µ' ? `<button onclick="completeOrder(${o.service_order_id})" class="btn-icon">‚úÖ</button>` : ''}
                    </td>
                </tr>
            `).join('');
    }

    function displayTestDrives(testDrives) {
        const tbody = document.getElementById('testdrivesTable');

        if (!testDrives || testDrives.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = testDrives.map(td => `
                <tr>
                    <td>${td.test_drive_id}</td>
                    <td>${formatDateTime(td.scheduled_date)}</td>
                    <td>${td.model_name || '-'}</td>
                    <td>${td.client_name || '-'}</td>
                    <td>${td.manager_name || '-'}</td>
                    <td>${td.duration} –º–∏–Ω</td>
                    <td><span class="badge badge-${getStatusColor(td.status)}">${td.status}</span></td>
                    <td>${td.feedback_rating ? '‚≠ê'.repeat(td.feedback_rating) : '-'}</td>
                    <td>
                        <button onclick="viewTestDrive(${td.test_drive_id})" class="btn-icon">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    function displayParts(parts) {
        const tbody = document.getElementById('partsTable');

        if (!parts || parts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = parts.map(p => `
                <tr>
                    <td>${p.part_number}</td>
                    <td>${p.part_name}</td>
                    <td>${p.model_name || '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è'}</td>
                    <td>${formatCurrency(p.price)}</td>
                    <td>${p.quantity_in_stock}</td>
                    <td>${p.min_quantity}</td>
                    <td><span class="badge badge-${getStockColor(p.stock_status)}">${p.stock_status}</span></td>
                    <td>${p.warehouse_city || '-'}</td>
                    <td>
                        <button onclick="editPart(${p.spare_part_id})" class="btn-icon">‚úèÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    function switchTab(tab) {
        currentTab = tab;

        // Hide all tabs
        document.getElementById('ordersTab').style.display = 'none';
        document.getElementById('testdrivesTab').style.display = 'none';
        document.getElementById('partsTab').style.display = 'none';

        // Reset button styles
        document.getElementById('btnOrders').className = 'btn btn-secondary';
        document.getElementById('btnTestDrives').className = 'btn btn-secondary';
        document.getElementById('btnParts').className = 'btn btn-secondary';

        // Show selected tab
        if (tab === 'orders') {
            document.getElementById('ordersTab').style.display = 'block';
            document.getElementById('btnOrders').className = 'btn btn-primary';
            loadServiceOrders();
        } else if (tab === 'testdrives') {
            document.getElementById('testdrivesTab').style.display = 'block';
            document.getElementById('btnTestDrives').className = 'btn btn-primary';
            loadTestDrives();
        } else if (tab === 'parts') {
            document.getElementById('partsTab').style.display = 'block';
            document.getElementById('btnParts').className = 'btn btn-primary';
            loadParts();
        }
    }

    function createOrder() {
        alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.');
    }

    function createTestDrive() {
        alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞. –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.');
    }

    function createPart() {
        alert('–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–∏. –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.');
    }

    function viewOrder(id) {
        alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞ #${id}`);
    }

    async function completeOrder(id) {
        if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑?')) return;

        try {
            await API.service.completeOrder(id);
            loadServiceOrders();
            alert('–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω');
        } catch (error) {
            console.error('Error completing order:', error);
            alert('–û—à–∏–±–∫–∞');
        }
    }

    function viewTestDrive(id) {
        alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞ #${id}`);
    }

    function editPart(id) {
        alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏ #${id}`);
    }

    function getStatusColor(status) {
        const colors = {
            '–ó–∞–≤–µ—Ä—à–µ–Ω': 'success',
            '–í —Ä–∞–±–æ—Ç–µ': 'warning',
            '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω': 'warning',
            '–û—Ç–º–µ–Ω–µ–Ω': 'danger',
            '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω': 'secondary',
        };
        return colors[status] || 'secondary';
    }

    function getStockColor(status) {
        const colors = {
            '–í –Ω–∞–ª–∏—á–∏–∏': 'success',
            '–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫': 'warning',
            '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫': 'danger',
            '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏': 'danger',
        };
        return colors[status] || 'secondary';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ru-BY', {
            minimumFractionDigits: 2
        }).format(value) + ' BYN';
    }

    function formatDate(date) {
        return new Date(date).toLocaleDateString('ru-BY');
    }

    function formatDateTime(date) {
        return new Date(date).toLocaleString('ru-BY');
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadServiceOrders();
    });
</script>
</body>
</html>