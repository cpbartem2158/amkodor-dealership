<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–∏—Å - –ê–º–∫–æ–¥–æ—Ä</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <style>
        /* Admin Layout Styles */
        .admin-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .admin-navbar {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-toggle span {
            width: 25px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .admin-logo {
            color: white;
            text-decoration: none;
        }

        .admin-logo h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar {
            background: #1f2937;
            color: white;
            width: 250px;
            min-height: calc(100vh - 80px);
            position: fixed;
            left: -250px;
            top: 80px;
            transition: left 0.3s ease;
            z-index: 1000;
        }

        .sidebar.open {
            left: 0;
        }

        .admin-content {
            flex: 1;
            padding: 2rem;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í—ã–π—Ç–∏" */
        .btn-logout {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-logout:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-logout:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .admin-content.sidebar-open {
            margin-left: 250px;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: #d1d5db;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #374151;
            color: white;
        }

        .menu-item.active {
            background: #1d4ed8;
            color: white;
            border-left-color: #60a5fa;
        }

        .menu-icon {
            font-size: 1.25rem;
        }

        .menu-text {
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                left: -100%;
            }

            .sidebar.open {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Navigation -->
        <nav class="admin-navbar">
            <div class="navbar-left">
                <button class="menu-toggle" id="menuToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="/admin/dashboard" class="admin-logo">
                    <h1>–ê–ú–ö–û–î–û–†</h1>
                </a>
            </div>

            <div class="navbar-right">
                <div class="user-info">
                    <span>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                    <button class="btn-logout" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
    <aside class="sidebar">
            <nav class="sidebar-menu">
                <a href="/admin/dashboard" class="menu-item">
                    <span class="menu-icon">üìä</span>
                    <span class="menu-text">–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
                <a href="/admin/vehicles" class="menu-item">
                    <span class="menu-icon">üöú</span>
                    <span class="menu-text">–¢–µ—Ö–Ω–∏–∫–∞</span>
                </a>
                <a href="/admin/sales" class="menu-item">
                    <span class="menu-icon">üí∞</span>
                    <span class="menu-text">–ü—Ä–æ–¥–∞–∂–∏</span>
                </a>
                <a href="/admin/customers" class="menu-item">
                    <span class="menu-icon">üë•</span>
                    <span class="menu-text">–ö–ª–∏–µ–Ω—Ç—ã</span>
                </a>
                <a href="/admin/employees" class="menu-item">
                    <span class="menu-icon">üëî</span>
                    <span class="menu-text">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                </a>
                <a href="/admin/warehouses" class="menu-item">
                    <span class="menu-icon">üè¢</span>
                    <span class="menu-text">–°–∫–ª–∞–¥—ã</span>
                </a>
                <a href="/admin/service" class="menu-item active">
                    <span class="menu-icon">üîß</span>
                    <span class="menu-text">–°–µ—Ä–≤–∏—Å</span>
                </a>
                <a href="/admin/reports" class="menu-item">
                    <span class="menu-icon">üìà</span>
                    <span class="menu-text">–û—Ç—á—ë—Ç—ã</span>
                </a>
                <a href="/admin/settings" class="menu-item">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span class="menu-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </nav>
    </aside>

        <!-- Main Content -->
        <main class="admin-content">
        <header class="main-header">
            <h1>–°–µ—Ä–≤–∏—Å–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h1>
            <div>
                <button onclick="switchTab('orders')" id="btnOrders" class="btn btn-primary">–ó–∞–∫–∞–∑—ã</button>
                <button onclick="switchTab('testdrives')" id="btnTestDrives" class="btn btn-secondary">–¢–µ—Å—Ç-–¥—Ä–∞–π–≤—ã</button>
                <button onclick="switchTab('parts')" id="btnParts" class="btn btn-secondary">–ó–∞–ø—á–∞—Å—Ç–∏</button>
            </div>
        </header>

        <!-- –°–µ—Ä–≤–∏—Å–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
        <section id="ordersTab" class="table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>–°–µ—Ä–≤–∏—Å–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
                <button onclick="createOrder()" class="btn btn-primary">+ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–¢–∏–ø —É—Å–ª—É–≥–∏</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="ordersTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>

        <!-- –¢–µ—Å—Ç-–¥—Ä–∞–π–≤—ã -->
        <section id="testdrivesTab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>–¢–µ—Å—Ç-–¥—Ä–∞–π–≤—ã</h3>
                <button onclick="createTestDrive()" class="btn btn-primary">+ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–¢–µ—Ö–Ω–∏–∫–∞</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="testdrivesTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>

        <!-- –ó–∞–ø—á–∞—Å—Ç–∏ -->
        <section id="partsTab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
                <button onclick="createPart()" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="partsTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>
    </main>
</div>

<script src="/static/js/api.js"></script>
<script>
    let currentTab = 'orders';
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
    let ordersData = [];
    let testDrivesData = [];
    let partsData = [];
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
    function saveOrdersData() {
        localStorage.setItem('adminOrdersData', JSON.stringify(ordersData));
    }
    
    function loadOrdersData() {
        const saved = localStorage.getItem('adminOrdersData');
        if (saved) {
            ordersData = JSON.parse(saved);
        }
    }
    
    function saveTestDrivesData() {
        localStorage.setItem('adminTestDrivesData', JSON.stringify(testDrivesData));
    }
    
    function loadTestDrivesData() {
        const saved = localStorage.getItem('adminTestDrivesData');
        if (saved) {
            testDrivesData = JSON.parse(saved);
        }
    }
    
    function savePartsData() {
        localStorage.setItem('adminPartsData', JSON.stringify(partsData));
    }
    
    function loadPartsData() {
        const saved = localStorage.getItem('adminPartsData');
        if (saved) {
            partsData = JSON.parse(saved);
        }
    }

    async function loadServiceOrders() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found, using fallback data');
                displayServiceRequests(getFallbackServiceRequests());
                return;
            }

            const response = await fetch('/api/admin/service-orders', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                console.log('API request failed, using fallback data');
                displayServiceRequests(getFallbackServiceRequests());
                return;
            }
            
            const data = await response.json();
            if (data.success && data.data) {
                displayServiceRequests(data.data);
            } else {
                displayServiceRequests(getFallbackServiceRequests());
            }
        } catch (error) {
            console.error('Error loading service orders:', error);
            displayServiceRequests(getFallbackServiceRequests());
        }
    }

    function getFallbackServiceRequests() {
        return [
            {
                id: 1,
                date: "2025-01-15",
                service_type: "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ",
                customer: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
                title: "–ü–ª–∞–Ω–æ–≤–æ–µ –¢–û —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–∞ –ê–ú–ö–û–î–û–† 3316",
                phone: "+375 29 123-45-67",
                status: "pending"
            },
            {
                id: 2,
                date: "2025-01-10",
                service_type: "–†–µ–º–æ–Ω—Ç",
                customer: "–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤",
                title: "–ó–∞–º–µ–Ω–∞ –≥–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä–∞ –ø–æ–¥—ä–µ–º–∞ —Å—Ç—Ä–µ–ª—ã",
                phone: "+375 29 234-56-78",
                status: "in-progress"
            },
            {
                id: 3,
                date: "2025-01-08",
                service_type: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
                customer: "–°–µ—Ä–≥–µ–π –°–∏–¥–æ—Ä–æ–≤",
                title: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã",
                phone: "+375 29 345-67-89",
                status: "completed"
            }
        ];
    }

    async function loadTestDrives() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found, using fallback data');
                displayTestDrives(getFallbackTestDrives());
                return;
            }

            const response = await fetch('/api/admin/test-drives', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                console.log('API request failed, using fallback data');
                displayTestDrives(getFallbackTestDrives());
                return;
            }
            
            const data = await response.json();
            if (data.success && data.data) {
                displayTestDrives(data.data);
            } else {
                displayTestDrives(getFallbackTestDrives());
            }
        } catch (error) {
            console.error('Error loading test drives:', error);
            displayTestDrives(getFallbackTestDrives());
        }
    }

    function getFallbackTestDrives() {
        return [
            {
                id: 1,
                date: "2025-01-15",
                customer: "–ê–ª–µ–∫—Å–µ–π –ö–æ–∑–ª–æ–≤",
                vehicle: "–ê–ú–ö–û–î–û–† 3316",
                phone: "+375 29 456-78-90",
                status: "scheduled"
            },
            {
                id: 2,
                date: "2025-01-12",
                customer: "–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞",
                vehicle: "–ê–ú–ö–û–î–û–† 3320",
                phone: "+375 29 567-89-01",
                status: "completed"
            },
            {
                id: 3,
                date: "2025-01-10",
                customer: "–î–º–∏—Ç—Ä–∏–π –°–º–∏—Ä–Ω–æ–≤",
                vehicle: "–ê–ú–ö–û–î–û–† 3316",
                phone: "+375 29 678-90-12",
                status: "cancelled"
            }
        ];
    }

    async function loadParts() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found, using fallback data');
                displayParts(getFallbackParts());
                return;
            }

            const response = await fetch('/api/admin/spare-parts', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                console.log('API request failed, using fallback data');
                displayParts(getFallbackParts());
                return;
            }
            
            const data = await response.json();
            if (data.success && data.data) {
                displayParts(data.data);
            } else {
                displayParts(getFallbackParts());
            }
        } catch (error) {
            console.error('Error loading parts:', error);
            displayParts(getFallbackParts());
        }
    }

    function getFallbackParts() {
        return [
            {
                id: 1,
                name: "–ì–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä –ø–æ–¥—ä–µ–º–∞ —Å—Ç—Ä–µ–ª—ã",
                part_number: "HC-3316-001",
                category: "–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞",
                price: 125000,
                stock: 5,
                status: "available"
            },
            {
                id: 2,
                name: "–§–∏–ª—å—Ç—Ä –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–∏–π",
                part_number: "HF-3316-002",
                category: "–§–∏–ª—å—Ç—Ä—ã",
                price: 15000,
                stock: 12,
                status: "available"
            },
            {
                id: 3,
                name: "–ú–∞—Å–ª–æ –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–æ–µ",
                part_number: "OH-3316-003",
                category: "–°–º–∞–∑–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã",
                price: 8500,
                stock: 8,
                status: "low_stock"
            },
            {
                id: 4,
                name: "–†–µ–º–µ–Ω—å –ø—Ä–∏–≤–æ–¥–∞",
                part_number: "RB-3316-004",
                category: "–ü—Ä–∏–≤–æ–¥",
                price: 25000,
                stock: 0,
                status: "out_of_stock"
            }
        ];
    }

    function displayServiceRequests(requests) {
        const tbody = document.getElementById('ordersTable');

        if (!requests || requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = requests.map(r => `
                <tr>
                    <td>${r.service_order_id || r.id}</td>
                    <td>${formatDate(r.order_date || r.date)}</td>
                    <td>${r.service_type || '-'}</td>
                    <td>${r.customer_id?.Int64 || r.customer || '-'}</td>
                    <td>${r.description?.String || r.title || '-'}</td>
                    <td>-</td>
                    <td>${r.cost || 0} —Ä—É–±.</td>
                    <td><span class="badge badge-${getStatusColor(r.status)}">${getStatusText(r.status)}</span></td>
                    <td>
                        <button onclick="viewServiceRequest(${r.service_order_id || r.id})" class="btn-icon">üëÅÔ∏è</button>
                        <button onclick="updateServiceRequestStatus(${r.service_order_id || r.id})" class="btn-icon">‚úèÔ∏è</button>
                        <button onclick="completeOrder(${r.service_order_id || r.id})" class="btn-icon">‚úÖ</button>
                    </td>
                </tr>
            `).join('');
    }

    function getStatusText(status) {
        const statusMap = {
            'pending': '–û–∂–∏–¥–∞–µ—Ç',
            'in-progress': '–í —Ä–∞–±–æ—Ç–µ',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
        };
        return statusMap[status] || status;
    }

    function displayTestDrives(testDrives) {
        const tbody = document.getElementById('testdrivesTable');

        if (!testDrives || testDrives.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = testDrives.map(td => `
                <tr>
                    <td>${td.test_drive_id}</td>
                    <td>${formatDateTime(td.scheduled_date)}</td>
                    <td>${td.model_name || '-'}</td>
                    <td>${td.client_name || '-'}</td>
                    <td>${td.manager_name || '-'}</td>
                    <td>${td.duration} –º–∏–Ω</td>
                    <td><span class="badge badge-${getStatusColor(td.status)}">${td.status}</span></td>
                    <td>${td.feedback_rating ? '‚≠ê'.repeat(td.feedback_rating) : '-'}</td>
                    <td>
                        <button onclick="viewTestDrive(${td.test_drive_id})" class="btn-icon">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    function displayParts(parts) {
        const tbody = document.getElementById('partsTable');

        if (!parts || parts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = parts.map(p => `
                <tr>
                    <td>${p.part_number}</td>
                    <td>${p.part_name}</td>
                    <td>${p.model_name || '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è'}</td>
                    <td>${formatCurrency(p.price)}</td>
                    <td>${p.quantity_in_stock}</td>
                    <td>${p.min_quantity}</td>
                    <td><span class="badge badge-${getStockColor(p.stock_status)}">${p.stock_status}</span></td>
                    <td>${p.warehouse_city || '-'}</td>
                    <td>
                        <button onclick="editPart(${p.spare_part_id})" class="btn-icon">‚úèÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    function switchTab(tab) {
        currentTab = tab;

        // Hide all tabs
        document.getElementById('ordersTab').style.display = 'none';
        document.getElementById('testdrivesTab').style.display = 'none';
        document.getElementById('partsTab').style.display = 'none';

        // Reset button styles
        document.getElementById('btnOrders').className = 'btn btn-secondary';
        document.getElementById('btnTestDrives').className = 'btn btn-secondary';
        document.getElementById('btnParts').className = 'btn btn-secondary';

        // Show selected tab
        if (tab === 'orders') {
            document.getElementById('ordersTab').style.display = 'block';
            document.getElementById('btnOrders').className = 'btn btn-primary';
            loadServiceOrders();
        } else if (tab === 'testdrives') {
            document.getElementById('testdrivesTab').style.display = 'block';
            document.getElementById('btnTestDrives').className = 'btn btn-primary';
            loadTestDrives();
        } else if (tab === 'parts') {
            document.getElementById('partsTab').style.display = 'block';
            document.getElementById('btnParts').className = 'btn btn-primary';
            loadParts();
        }
    }

    function createOrder() {
        const modal = `
            <div class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞</h3>
                        <span class="close" onclick="closeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="createOrderForm">
                            <div style="margin-bottom: 15px;">
                                <label for="customerName" style="display: block; margin-bottom: 5px; font-weight: 600;">–ö–ª–∏–µ–Ω—Ç:</label>
                                <input type="text" id="customerName" name="customerName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="customerPhone" style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                                <input type="tel" id="customerPhone" name="customerPhone" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="serviceType" style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–∏–ø —É—Å–ª—É–≥–∏:</label>
                                <select id="serviceType" name="serviceType" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å–ª—É–≥–∏</option>
                                    <option value="maintenance">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
                                    <option value="repair">–†–µ–º–æ–Ω—Ç –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</option>
                                    <option value="parts">–ó–∞–º–µ–Ω–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π</option>
                                    <option value="mobile">–í—ã–µ–∑–¥–Ω–æ–π —Å–µ—Ä–≤–∏—Å</option>
                                    <option value="consultation">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</option>
                                    <option value="emergency">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="orderTitle" style="display: block; margin-bottom: 5px; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:</label>
                                <input type="text" id="orderTitle" name="orderTitle" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="orderDescription" style="display: block; margin-bottom: 5px; font-weight: 600;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                                <textarea id="orderDescription" name="orderDescription" rows="4" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="orderDate" style="display: block; margin-bottom: 5px; font-weight: 600;">–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
                                <input type="date" id="orderDate" name="orderDate" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="orderPrice" style="display: block; margin-bottom: 5px; font-weight: 600;">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):</label>
                                <input type="number" id="orderPrice" name="orderPrice" min="0" step="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                        <button onclick="submitOrder()" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
                        <button onclick="closeModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
    }

    function submitOrder() {
        const form = document.getElementById('createOrderForm');
        const formData = new FormData(form);
        
        const orderData = {
            customer: formData.get('customerName'),
            phone: formData.get('customerPhone'),
            service_type: formData.get('serviceType'),
            title: formData.get('orderTitle'),
            description: formData.get('orderDescription'),
            date: formData.get('orderDate'),
            price: formData.get('orderPrice') || 0,
            status: 'pending'
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!orderData.customer || !orderData.phone || !orderData.service_type || !orderData.title || !orderData.description) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ —Ç–∞–±–ª–∏—Ü—É (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã API –∑–∞–ø—Ä–æ—Å)
        addOrderToTable(orderData);
        
        alert(`–ó–∞–∫–∞–∑ "${orderData.title}" —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`);
        closeModal();
    }
    
    async function addOrderToTable(orderData) {
        const serviceTypeMap = {
            'maintenance': '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ',
            'repair': '–†–µ–º–æ–Ω—Ç –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
            'parts': '–ó–∞–º–µ–Ω–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π',
            'mobile': '–í—ã–µ–∑–¥–Ω–æ–π —Å–µ—Ä–≤–∏—Å',
            'consultation': '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏',
            'emergency': '–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'
        };
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const response = await fetch('/api/admin/service-orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    vehicle_id: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    customer_id: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                    employee_id: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    service_type: serviceTypeMap[orderData.service_type] || orderData.service_type,
                    description: orderData.title,
                    cost: parseFloat(orderData.price) || 0,
                    status: orderData.status || '–í —Ä–∞–±–æ—Ç–µ'
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    alert(`–ó–∞–∫–∞–∑ "${orderData.title}" —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`);
                    loadServiceOrders(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
            }
        } catch (error) {
            console.error('Error creating service order:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
        }
    }
    
    function updateOrdersTable() {
        const tbody = document.getElementById('ordersTable');
        tbody.innerHTML = '';
        
        if (ordersData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        
        ordersData.forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.date}</td>
                <td>${order.service_type}</td>
                <td>${order.customer}</td>
                <td>${order.title}</td>
                <td>${order.phone}</td>
                <td>${order.price} ‚ÇΩ</td>
                <td><span class="badge badge-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></td>
                <td>
                    <button onclick="viewServiceRequest(${order.id})" class="btn-icon">üëÅÔ∏è</button>
                    <button onclick="updateServiceRequestStatus(${order.id})" class="btn-icon">‚úèÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function createTestDrive() {
        const modal = `
            <div class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>–ó–∞–ø–∏—Å—å –Ω–∞ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤</h3>
                        <span class="close" onclick="closeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="createTestDriveForm">
                            <div style="margin-bottom: 15px;">
                                <label for="testDriveCustomer" style="display: block; margin-bottom: 5px; font-weight: 600;">–ö–ª–∏–µ–Ω—Ç:</label>
                                <input type="text" id="testDriveCustomer" name="testDriveCustomer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="testDrivePhone" style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                                <input type="tel" id="testDrivePhone" name="testDrivePhone" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="testDriveVehicle" style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–µ—Ö–Ω–∏–∫–∞:</label>
                                <select id="testDriveVehicle" name="testDriveVehicle" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É</option>
                                    <option value="–ê–ú–ö–û–î–û–† 3316">–ê–ú–ö–û–î–û–† 3316</option>
                                    <option value="–ê–ú–ö–û–î–û–† 3320">–ê–ú–ö–û–î–û–† 3320</option>
                                    <option value="–ê–ú–ö–û–î–û–† 3330">–ê–ú–ö–û–î–û–† 3330</option>
                                    <option value="–ê–ú–ö–û–î–û–† 3340">–ê–ú–ö–û–î–û–† 3340</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="testDriveDate" style="display: block; margin-bottom: 5px; font-weight: 600;">–î–∞—Ç–∞ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞:</label>
                                <input type="date" id="testDriveDate" name="testDriveDate" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="testDriveTime" style="display: block; margin-bottom: 5px; font-weight: 600;">–í—Ä–µ–º—è:</label>
                                <input type="time" id="testDriveTime" name="testDriveTime" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="testDriveNotes" style="display: block; margin-bottom: 5px; font-weight: 600;">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</label>
                                <textarea id="testDriveNotes" name="testDriveNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                        <button onclick="submitTestDrive()" class="btn btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å</button>
                        <button onclick="closeModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('testDriveDate').value = tomorrow.toISOString().split('T')[0];
    }

    function submitTestDrive() {
        const form = document.getElementById('createTestDriveForm');
        const formData = new FormData(form);
        
        const testDriveData = {
            customer: formData.get('testDriveCustomer'),
            phone: formData.get('testDrivePhone'),
            vehicle: formData.get('testDriveVehicle'),
            date: formData.get('testDriveDate'),
            time: formData.get('testDriveTime'),
            notes: formData.get('testDriveNotes') || '',
            status: 'scheduled'
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!testDriveData.customer || !testDriveData.phone || !testDriveData.vehicle || !testDriveData.date || !testDriveData.time) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤ –≤ —Ç–∞–±–ª–∏—Ü—É
        addTestDriveToTable(testDriveData);
        
        alert(`–¢–µ—Å—Ç-–¥—Ä–∞–π–≤ –¥–ª—è ${testDriveData.customer} –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ ${testDriveData.date} –≤ ${testDriveData.time}!`);
        closeModal();
    }
    
    async function addTestDriveToTable(testDriveData) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const response = await fetch('/api/admin/test-drives', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    vehicle_id: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    customer_id: null,
                    corporate_client_id: null,
                    employee_id: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    scheduled_date: new Date(testDriveData.date + 'T' + testDriveData.time).toISOString(),
                    duration: 60,
                    status: testDriveData.status || '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω'
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    alert(`–¢–µ—Å—Ç-–¥—Ä–∞–π–≤ –¥–ª—è ${testDriveData.customer} –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ ${testDriveData.date} –≤ ${testDriveData.time}!`);
                    loadTestDrives(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞');
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞');
            }
        } catch (error) {
            console.error('Error creating test drive:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞');
        }
    }
    
    function updateTestDrivesTable() {
        const tbody = document.getElementById('testdrivesTable');
        tbody.innerHTML = '';
        
        if (testDrivesData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        
        testDrivesData.forEach(testDrive => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${testDrive.id}</td>
                <td>${testDrive.date}</td>
                <td>${testDrive.customer}</td>
                <td>${testDrive.vehicle}</td>
                <td>${testDrive.phone}</td>
                <td>${testDrive.time}</td>
                <td><span class="badge badge-${getStatusColor(testDrive.status)}">${getStatusText(testDrive.status)}</span></td>
                <td>
                    <button onclick="viewTestDrive(${testDrive.id})" class="btn-icon">üëÅÔ∏è</button>
                    <button onclick="editTestDrive(${testDrive.id})" class="btn-icon">‚úèÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function createPart() {
        const modal = `
            <div class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                <div class="modal-content" style="background-color: #fefefe; margin: 2% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏</h3>
                        <span class="close" onclick="closeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="createPartForm">
                            <div style="margin-bottom: 15px;">
                                <label for="partName" style="display: block; margin-bottom: 5px; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏:</label>
                                <input type="text" id="partName" name="partName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="partNumber" style="display: block; margin-bottom: 5px; font-weight: 600;">–ê—Ä—Ç–∏–∫—É–ª:</label>
                                <input type="text" id="partNumber" name="partNumber" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="partCategory" style="display: block; margin-bottom: 5px; font-weight: 600;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                                <select id="partCategory" name="partCategory" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                    <option value="–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞">–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞</option>
                                    <option value="–§–∏–ª—å—Ç—Ä—ã">–§–∏–ª—å—Ç—Ä—ã</option>
                                    <option value="–°–º–∞–∑–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã">–°–º–∞–∑–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
                                    <option value="–ü—Ä–∏–≤–æ–¥">–ü—Ä–∏–≤–æ–¥</option>
                                    <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                                    <option value="–ö—É–∑–æ–≤">–ö—É–∑–æ–≤</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="partPrice" style="display: block; margin-bottom: 5px; font-weight: 600;">–¶–µ–Ω–∞ (‚ÇΩ):</label>
                                <input type="number" id="partPrice" name="partPrice" min="0" step="100" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="partStock" style="display: block; margin-bottom: 5px; font-weight: 600;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ:</label>
                                <input type="number" id="partStock" name="partStock" min="0" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="partDescription" style="display: block; margin-bottom: 5px; font-weight: 600;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                                <textarea id="partDescription" name="partDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                        <button onclick="submitPart()" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                        <button onclick="closeModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);
    }
    
    function submitPart() {
        const form = document.getElementById('createPartForm');
        const formData = new FormData(form);
        
        const partData = {
            name: formData.get('partName'),
            part_number: formData.get('partNumber'),
            category: formData.get('partCategory'),
            price: formData.get('partPrice'),
            stock: formData.get('partStock'),
            description: formData.get('partDescription') || '',
            status: 'available'
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!partData.name || !partData.part_number || !partData.category || !partData.price || !partData.stock) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—á–∞—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É
        addPartToTable(partData);
        
        alert(`–ó–∞–ø—á–∞—Å—Ç—å "${partData.name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥!`);
        closeModal();
    }
    
    async function addPartToTable(partData) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const response = await fetch('/api/admin/spare-parts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    part_number: partData.part_number,
                    part_name: partData.name,
                    model_id: null,
                    price: parseFloat(partData.price) || 0,
                    quantity_in_stock: parseInt(partData.stock) || 0,
                    min_quantity: 0,
                    warehouse_id: 1 // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    alert(`–ó–∞–ø—á–∞—Å—Ç—å "${partData.name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥!`);
                    loadParts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏');
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏');
            }
        } catch (error) {
            console.error('Error creating spare part:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏');
        }
    }
    
    function updatePartsTable() {
        const tbody = document.getElementById('partsTable');
        tbody.innerHTML = '';
        
        if (partsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        
        partsData.forEach(part => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${part.part_number}</td>
                <td>${part.name}</td>
                <td>${part.category}</td>
                <td>${part.price} ‚ÇΩ</td>
                <td>${part.stock}</td>
                <td><span class="badge badge-${getStatusColor(part.status)}">${getStatusText(part.status)}</span></td>
                <td>
                    <button onclick="editPart(${part.id})" class="btn-icon">‚úèÔ∏è</button>
                    <button onclick="deletePart(${part.id})" class="btn-icon">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function viewOrder(id) {
        alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞ #${id}`);
    }

    async function completeOrder(id) {
        if (!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑?')) return;

        try {
            await API.service.completeOrder(id);
            loadServiceOrders();
            alert('–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω');
        } catch (error) {
            console.error('Error completing order:', error);
            alert('–û—à–∏–±–∫–∞');
        }
    }

    function viewTestDrive(id) {
        alert(`–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞ #${id}`);
    }
    
    function editTestDrive(id) {
        alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤–∞ #${id}`);
    }
    
    function editPart(id) {
        alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏ #${id}`);
    }
    
    async function deletePart(id) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å?')) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                    return;
                }

                const response = await fetch(`/api/admin/spare-parts/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert('–ó–∞–ø—á–∞—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
                        loadParts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏');
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏');
                }
            } catch (error) {
                console.error('Error deleting spare part:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏');
            }
        }
    }

    function viewServiceRequest(id) {
        // –ù–∞–π—Ç–∏ –∑–∞—è–≤–∫—É –ø–æ ID
        const requests = getFallbackServiceRequests();
        const request = requests.find(r => r.id === id);
        
        if (request) {
            const modal = `
                <div class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>–ó–∞—è–≤–∫–∞ #${request.id}</h3>
                            <span class="close" onclick="closeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                        </div>
                        <div class="modal-body">
                            <p><strong>–î–∞—Ç–∞:</strong> ${request.date}</p>
                            <p><strong>–¢–∏–ø —É—Å–ª—É–≥–∏:</strong> ${request.service_type}</p>
                            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${request.customer}</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${request.phone}</p>
                            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${request.title}</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge badge-${getStatusColor(request.status)}">${getStatusText(request.status)}</span></p>
                        </div>
                        <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                            <button onclick="updateServiceRequestStatus(${id})" class="btn btn-primary">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                            <button onclick="closeModal()" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
    }

    function updateServiceRequestStatus(id) {
        const statuses = [
            { value: 'pending', text: '–û–∂–∏–¥–∞–µ—Ç' },
            { value: 'in-progress', text: '–í —Ä–∞–±–æ—Ç–µ' },
            { value: 'completed', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' },
            { value: 'cancelled', text: '–û—Ç–º–µ–Ω–µ–Ω–æ' }
        ];
        
        const statusOptions = statuses.map(s => `${s.value} - ${s.text}`).join('\n');
        const newStatus = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞—è–≤–∫–∏ #${id}:\n\n${statusOptions}\n\n–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ:`, 'pending');
        
        if (newStatus && statuses.find(s => s.value === newStatus)) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Ç–∞–±–ª–∏—Ü–µ
            const rows = document.querySelectorAll('#ordersTable tr');
            rows.forEach(row => {
                const idCell = row.cells[0];
                if (idCell && idCell.textContent == id) {
                    const statusCell = row.cells[7];
                    if (statusCell) {
                        const statusText = statuses.find(s => s.value === newStatus)?.text || newStatus;
                        statusCell.innerHTML = `<span class="badge badge-${getStatusColor(newStatus)}">${statusText}</span>`;
                    }
                }
            });
            
            alert(`–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ #${id} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${statuses.find(s => s.value === newStatus)?.text}"`);
        }
    }

    function closeModal() {
        const modal = document.querySelector('.modal');
        if (modal) {
            modal.remove();
        }
    }

    function getStatusColor(status) {
        const colors = {
            '–ó–∞–≤–µ—Ä—à–µ–Ω': 'success',
            '–í —Ä–∞–±–æ—Ç–µ': 'warning',
            '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω': 'warning',
            '–û—Ç–º–µ–Ω–µ–Ω': 'danger',
            '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω': 'secondary',
        };
        return colors[status] || 'secondary';
    }

    function getStockColor(status) {
        const colors = {
            '–í –Ω–∞–ª–∏—á–∏–∏': 'success',
            '–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫': 'warning',
            '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫': 'danger',
            '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏': 'danger',
        };
        return colors[status] || 'secondary';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ru-BY', {
            minimumFractionDigits: 2
        }).format(value) + ' BYN';
    }

    function formatDate(date) {
        return new Date(date).toLocaleDateString('ru-BY');
    }

    function formatDateTime(date) {
        return new Date(date).toLocaleString('ru-BY');
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadServiceOrders();
        
        // Mobile menu functionality
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        const adminContent = document.querySelector('.admin-content');

        if (menuToggle) {
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                adminContent.classList.toggle('sidebar-open');
            });
        }

        // Close sidebar when clicking outside
        document.addEventListener('click', function(event) {
            if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                sidebar.classList.remove('open');
                adminContent.classList.remove('sidebar-open');
            }
        });

        // Auto-close sidebar when clicking menu items
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                sidebar.classList.remove('open');
                adminContent.classList.remove('sidebar-open');
            });
        });
    });
</script>
        </main>
    </div>
</body>
</html>