<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ - –ê–º–∫–æ–¥–æ—Ä</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
<div class="admin-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>–ê–ú–ö–û–î–û–†</h2>
            <p>–ê–≤—Ç–æ—Å–∞–ª–æ–Ω</p>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <span class="icon">üìä</span>
                –î–∞—à–±–æ—Ä–¥
            </a>
            <a href="/admin/vehicles" class="nav-item">
                <span class="icon">üöú</span>
                –¢–µ—Ö–Ω–∏–∫–∞
            </a>
            <a href="/admin/sales" class="nav-item">
                <span class="icon">üí∞</span>
                –ü—Ä–æ–¥–∞–∂–∏
            </a>
            <a href="/admin/customers" class="nav-item">
                <span class="icon">üë•</span>
                –ö–ª–∏–µ–Ω—Ç—ã
            </a>
            <a href="/admin/employees" class="nav-item active">
                <span class="icon">üëî</span>
                –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
            </a>
            <a href="/admin/service" class="nav-item">
                <span class="icon">üîß</span>
                –°–µ—Ä–≤–∏—Å
            </a>
            <a href="/admin/reports" class="nav-item">
                <span class="icon">üìà</span>
                –û—Ç—á–µ—Ç—ã
            </a>
        </nav>
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <h1>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
        </header>

        <section class="table-container">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>–§–ò–û</th>
                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>Email</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                    <th>–°—Ç–∞–∂</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="employeesTable">
                <tr>
                    <td colspan="10" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>
    </main>
</div>

<div id="employeeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="employeeForm" onsubmit="saveEmployee(event)">
            <div class="form-group">
                <label class="form-label">–§–∞–º–∏–ª–∏—è *</label>
                <input type="text" id="lastName" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–ò–º—è *</label>
                <input type="text" id="firstName" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                <input type="text" id="middleName" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="form-group" id="passwordField">
                <label class="form-label">–ü–∞—Ä–æ–ª—å *</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="phone" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å *</label>
                <select id="positionId" class="form-control" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                    <option value="1">–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</option>
                    <option value="2">–°—Ç–∞—Ä—à–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä</option>
                    <option value="3">–ú–µ—Ö–∞–Ω–∏–∫</option>
                    <option value="4">–ú–∞—Å—Ç–µ—Ä —Å–µ—Ä–≤–∏—Å–∞</option>
                    <option value="8">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–§–∏–ª–∏–∞–ª</label>
                <select id="warehouseId" class="form-control">
                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–ó–∞—Ä–ø–ª–∞—Ç–∞</label>
                <input type="number" step="0.01" id="salary" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="isActive" checked> –ê–∫—Ç–∏–≤–µ–Ω
                </label>
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<script src="/static/js/api.js"></script>
<script>
    let currentEmployeeId = null;

    async function loadEmployees() {
        try {
            const employees = await API.employees.getAll({ limit: 100 });
            displayEmployees(employees);
        } catch (error) {
            console.error('Error loading employees:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    async function loadWarehouses() {
        try {
            const warehouses = await API.warehouses.getAll();
            const select = document.getElementById('warehouseId');
            select.innerHTML = '<option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>' +
                warehouses.map(w => `<option value="${w.warehouse_id}">${w.warehouse_name}</option>`).join('');
        } catch (error) {
            console.error('Error loading warehouses:', error);
        }
    }

    function displayEmployees(employees) {
        const tbody = document.getElementById('employeesTable');

        if (!employees || employees.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = employees.map(e => `
                <tr>
                    <td>${e.employee_id}</td>
                    <td>${e.full_name || `${e.last_name} ${e.first_name}`}</td>
                    <td>${e.position_name || '-'}</td>
                    <td>${e.warehouse_name || '-'}</td>
                    <td>${e.email || '-'}</td>
                    <td>${e.phone || '-'}</td>
                    <td>${e.salary ? formatCurrency(e.salary) : '-'}</td>
                    <td>${e.years_of_service || 0} –ª–µ—Ç</td>
                    <td><span class="badge badge-${e.is_active ? 'success' : 'danger'}">${e.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span></td>
                    <td>
                        <button onclick="editEmployee(${e.employee_id})" class="btn-icon">‚úèÔ∏è</button>
                        <button onclick="deleteEmployee(${e.employee_id})" class="btn-icon">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    function openCreateModal() {
        currentEmployeeId = null;
        document.getElementById('modalTitle').textContent = '–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫';
        document.getElementById('employeeForm').reset();
        document.getElementById('passwordField').style.display = 'block';
        document.getElementById('password').required = true;
        document.getElementById('employeeModal').classList.add('active');
        loadWarehouses();
    }

    async function editEmployee(id) {
        try {
            const employee = await API.employees.getById(id);
            currentEmployeeId = id;

            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
            document.getElementById('firstName').value = employee.first_name;
            document.getElementById('lastName').value = employee.last_name;
            document.getElementById('middleName').value = employee.middle_name || '';
            document.getElementById('email').value = employee.email || '';
            document.getElementById('phone').value = employee.phone || '';
            document.getElementById('positionId').value = employee.position_id;
            document.getElementById('warehouseId').value = employee.warehouse_id || '';
            document.getElementById('salary').value = employee.salary || '';
            document.getElementById('isActive').checked = employee.is_active;

            document.getElementById('passwordField').style.display = 'none';
            document.getElementById('password').required = false;

            document.getElementById('employeeModal').classList.add('active');
            loadWarehouses();
        } catch (error) {
            console.error('Error loading employee:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    async function saveEmployee(event) {
        event.preventDefault();

        const data = {
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            middle_name: document.getElementById('middleName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            position_id: parseInt(document.getElementById('positionId').value),
            warehouse_id: document.getElementById('warehouseId').value ? parseInt(document.getElementById('warehouseId').value) : null,
            salary: document.getElementById('salary').value ? parseFloat(document.getElementById('salary').value) : null,
            is_active: document.getElementById('isActive').checked,
        };

        if (!currentEmployeeId) {
            data.password = document.getElementById('password').value;
        }

        try {
            if (currentEmployeeId) {
                await API.employees.update(currentEmployeeId, data);
            } else {
                await API.employees.create(data);
            }

            closeModal();
            loadEmployees();
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
        } catch (error) {
            console.error('Error saving employee:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    }

    async function deleteEmployee(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;

        try {
            await API.employees.delete(id);
            loadEmployees();
            alert('–£–¥–∞–ª–µ–Ω–æ');
        } catch (error) {
            console.error('Error deleting employee:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    }

    function closeModal() {
        document.getElementById('employeeModal').classList.remove('active');
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ru-BY', {
            minimumFractionDigits: 2
        }).format(value) + ' BYN';
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', loadEmployees);
</script>
</body>
</html>