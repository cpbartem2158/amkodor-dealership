<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Ö–Ω–∏–∫–∞ - –ê–º–∫–æ–¥–æ—Ä</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
<div class="admin-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>–ê–ú–ö–û–î–û–†</h2>
            <p>–ê–≤—Ç–æ—Å–∞–ª–æ–Ω</p>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <span class="icon">üìä</span>
                –î–∞—à–±–æ—Ä–¥
            </a>
            <a href="/admin/vehicles" class="nav-item active">
                <span class="icon">üöú</span>
                –¢–µ—Ö–Ω–∏–∫–∞
            </a>
            <a href="/admin/sales" class="nav-item">
                <span class="icon">üí∞</span>
                –ü—Ä–æ–¥–∞–∂–∏
            </a>
            <a href="/admin/customers" class="nav-item">
                <span class="icon">üë•</span>
                –ö–ª–∏–µ–Ω—Ç—ã
            </a>
            <a href="/admin/employees" class="nav-item">
                <span class="icon">üëî</span>
                –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
            </a>
            <a href="/admin/service" class="nav-item">
                <span class="icon">üîß</span>
                –°–µ—Ä–≤–∏—Å
            </a>
            <a href="/admin/reports" class="nav-item">
                <span class="icon">üìà</span>
                –û—Ç—á–µ—Ç—ã
            </a>
        </nav>
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
        </header>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <section class="filters-section">
            <div class="filters">
                <input type="text" id="searchModel" placeholder="–ú–æ–¥–µ–ª—å" class="form-control">
                <input type="text" id="searchCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" class="form-control">
                <select id="filterStatus" class="form-control">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="–í –Ω–∞–ª–∏—á–∏–∏">–í –Ω–∞–ª–∏—á–∏–∏</option>
                    <option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω–æ</option>
                    <option value="–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</option>
                </select>
                <button onclick="searchVehicles()" class="btn btn-secondary">–ü–æ–∏—Å–∫</button>
                <button onclick="resetFilters()" class="btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </section>

        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
        <section class="table-container">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>–ú–æ–¥–µ–ª—å</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–ì–æ–¥</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–°–∫–∏–¥–∫–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–∫–ª–∞–¥</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="vehiclesTable">
                <tr>
                    <td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="pagination" id="pagination"></div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="vehicleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="vehicleForm" onsubmit="saveVehicle(event)">
            <div class="form-group">
                <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                <input type="number" id="modelId" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–°–∫–ª–∞–¥</label>
                <input type="number" id="warehouseId" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">VIN</label>
                <input type="text" id="vin" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                <input type="text" id="serialNumber" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                <input type="number" id="manufactureYear" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–¶–≤–µ—Ç</label>
                <input type="text" id="color" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">–¶–µ–Ω–∞</label>
                <input type="number" step="0.01" id="price" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">–°–∫–∏–¥–∫–∞ (%)</label>
                <input type="number" step="0.01" id="discount" class="form-control" value="0">
            </div>
            <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select id="status" class="form-control">
                    <option value="–í –Ω–∞–ª–∏—á–∏–∏">–í –Ω–∞–ª–∏—á–∏–∏</option>
                    <option value="–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</option>
                    <option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω–æ</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<script src="/static/js/api.js"></script>
<script>
    let currentVehicleId = null;
    let currentPage = 0;
    const perPage = 20;

    async function loadVehicles() {
        try {
            const vehicles = await API.vehicles.getAll({ limit: perPage, offset: currentPage * perPage });
            displayVehicles(vehicles);
        } catch (error) {
            console.error('Error loading vehicles:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    function displayVehicles(vehicles) {
        const tbody = document.getElementById('vehiclesTable');

        if (!vehicles || vehicles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = vehicles.map(v => `
                <tr>
                    <td>${v.vehicle_id}</td>
                    <td>${v.model_name || '-'}</td>
                    <td>${v.category_name || '-'}</td>
                    <td>${v.manufacture_year}</td>
                    <td>${formatCurrency(v.price)}</td>
                    <td>${v.discount}%</td>
                    <td><span class="badge badge-${getStatusColor(v.status)}">${v.status}</span></td>
                    <td>${v.warehouse_city || '-'}</td>
                    <td>
                        <button onclick="editVehicle(${v.vehicle_id})" class="btn-icon">‚úèÔ∏è</button>
                        <button onclick="viewHistory(${v.vehicle_id})" class="btn-icon">üìú</button>
                        <button onclick="deleteVehicle(${v.vehicle_id})" class="btn-icon">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    async function searchVehicles() {
        const params = {
            model_name: document.getElementById('searchModel').value,
            category_name: document.getElementById('searchCategory').value,
            status: document.getElementById('filterStatus').value,
        };

        try {
            const vehicles = await API.vehicles.search(params);
            displayVehicles(vehicles);
        } catch (error) {
            console.error('Error searching vehicles:', error);
        }
    }

    function resetFilters() {
        document.getElementById('searchModel').value = '';
        document.getElementById('searchCategory').value = '';
        document.getElementById('filterStatus').value = '';
        loadVehicles();
    }

    function openCreateModal() {
        currentVehicleId = null;
        document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É';
        document.getElementById('vehicleForm').reset();
        document.getElementById('vehicleModal').classList.add('active');
    }

    async function editVehicle(id) {
        try {
            const vehicle = await API.vehicles.getById(id);
            currentVehicleId = id;

            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É';
            document.getElementById('modelId').value = vehicle.model_id;
            document.getElementById('warehouseId').value = vehicle.warehouse_id;
            document.getElementById('vin').value = vehicle.vin || '';
            document.getElementById('serialNumber').value = vehicle.serial_number;
            document.getElementById('manufactureYear').value = vehicle.manufacture_year;
            document.getElementById('color').value = vehicle.color || '';
            document.getElementById('price').value = vehicle.price;
            document.getElementById('discount').value = vehicle.discount;
            document.getElementById('status').value = vehicle.status;

            document.getElementById('vehicleModal').classList.add('active');
        } catch (error) {
            console.error('Error loading vehicle:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    async function saveVehicle(event) {
        event.preventDefault();

        const data = {
            model_id: parseInt(document.getElementById('modelId').value),
            warehouse_id: parseInt(document.getElementById('warehouseId').value),
            vin: document.getElementById('vin').value,
            serial_number: document.getElementById('serialNumber').value,
            manufacture_year: parseInt(document.getElementById('manufactureYear').value),
            color: document.getElementById('color').value,
            price: parseFloat(document.getElementById('price').value),
            discount: parseFloat(document.getElementById('discount').value),
            status: document.getElementById('status').value,
        };

        try {
            if (currentVehicleId) {
                await API.vehicles.update(currentVehicleId, data);
            } else {
                await API.vehicles.create(data);
            }

            closeModal();
            loadVehicles();
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
        } catch (error) {
            console.error('Error saving vehicle:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    }

    async function deleteVehicle(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–µ—Ö–Ω–∏–∫—É?')) return;

        try {
            await API.vehicles.delete(id);
            loadVehicles();
            alert('–£–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
        } catch (error) {
            console.error('Error deleting vehicle:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    }

    async function viewHistory(id) {
        try {
            const history = await API.vehicles.getHistory(id);
            console.log('History:', history);
            alert(`–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–∏ #${id}\n\n–°–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
        } catch (error) {
            console.error('Error loading history:', error);
        }
    }

    function closeModal() {
        document.getElementById('vehicleModal').classList.remove('active');
    }

    function getStatusColor(status) {
        const colors = {
            '–í –Ω–∞–ª–∏—á–∏–∏': 'success',
            '–ü—Ä–æ–¥–∞–Ω–æ': 'danger',
            '–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ': 'warning',
        };
        return colors[status] || 'secondary';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ru-BY', {
            style: 'decimal',
            minimumFractionDigits: 2
        }).format(value);
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', loadVehicles);
</script>
</body>
</html>