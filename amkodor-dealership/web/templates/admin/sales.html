<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥–∞–∂–∏ - –ê–º–∫–æ–¥–æ—Ä</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
<div class="admin-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>–ê–ú–ö–û–î–û–†</h2>
            <p>–ê–≤—Ç–æ—Å–∞–ª–æ–Ω</p>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <span class="icon">üìä</span>
                –î–∞—à–±–æ—Ä–¥
            </a>
            <a href="/admin/vehicles" class="nav-item">
                <span class="icon">üöú</span>
                –¢–µ—Ö–Ω–∏–∫–∞
            </a>
            <a href="/admin/sales" class="nav-item active">
                <span class="icon">üí∞</span>
                –ü—Ä–æ–¥–∞–∂–∏
            </a>
            <a href="/admin/customers" class="nav-item">
                <span class="icon">üë•</span>
                –ö–ª–∏–µ–Ω—Ç—ã
            </a>
            <a href="/admin/employees" class="nav-item">
                <span class="icon">üëî</span>
                –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
            </a>
            <a href="/admin/service" class="nav-item">
                <span class="icon">üîß</span>
                –°–µ—Ä–≤–∏—Å
            </a>
            <a href="/admin/reports" class="nav-item">
                <span class="icon">üìà</span>
                –û—Ç—á–µ—Ç—ã
            </a>
        </nav>
        <div class="sidebar-footer">
            <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <h1>–ü—Ä–æ–¥–∞–∂–∏</h1>
            <button onclick="openCreateModal()" class="btn btn-primary">+ –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</button>
        </header>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <section class="filters-section">
            <div class="filters">
                <input type="date" id="startDate" class="form-control" placeholder="–î–∞—Ç–∞ –æ—Ç">
                <input type="date" id="endDate" class="form-control" placeholder="–î–∞—Ç–∞ –¥–æ">
                <select id="filterStatus" class="form-control">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–∞">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                    <option value="–í –ø—Ä–æ—Ü–µ—Å—Å–µ">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                    <option value="–û—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
                <button onclick="filterSales()" class="btn btn-secondary">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="resetFilters()" class="btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </section>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥–∞–∂ -->
        <section class="table-container">
            <table>
                <thead>
                <tr>
                    <th>‚Ññ –î–æ–≥–æ–≤–æ—Ä–∞</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ú–æ–¥–µ–ª—å</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–°–∫–∏–¥–∫–∞</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody id="salesTable">
                <tr>
                    <td colspan="10" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                </tr>
                </tbody>
            </table>
        </section>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏ -->
<div id="saleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">–ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="saleForm" onsubmit="saveSale(event)">
            <div class="form-group">
                <label class="form-label">–¢–µ—Ö–Ω–∏–∫–∞ *</label>
                <select id="vehicleId" class="form-control" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞ *</label>
                <select id="clientType" class="form-control" onchange="toggleClientFields()">
                    <option value="customer">–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
                    <option value="corporate">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
                </select>
            </div>
            <div class="form-group" id="customerField">
                <label class="form-label">–ö–ª–∏–µ–Ω—Ç (—Ñ–∏–∑. –ª–∏—Ü–æ) *</label>
                <select id="customerId" class="form-control">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>
                </select>
            </div>
            <div class="form-group" id="corporateField" style="display: none;">
                <label class="form-label">–ö–ª–∏–µ–Ω—Ç (—é—Ä. –ª–∏—Ü–æ) *</label>
                <select id="corporateClientId" class="form-control">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä *</label>
                <select id="employeeId" class="form-control" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–∏–ø –æ–ø–ª–∞—Ç—ã</label>
                <select id="paymentType" class="form-control">
                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                    <option value="–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π">–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π</option>
                    <option value="–ö—Ä–µ–¥–∏—Ç">–ö—Ä–µ–¥–∏—Ç</option>
                    <option value="–õ–∏–∑–∏–Ω–≥">–õ–∏–∑–∏–Ω–≥</option>
                    <option value="–†–∞—Å—Å—Ä–æ—á–∫–∞">–†–∞—Å—Å—Ä–æ—á–∫–∞</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ (%)</label>
                <input type="number" step="0.01" id="additionalDiscount" class="form-control" value="0">
            </div>
            <div class="form-group">
                <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                <textarea id="notes" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
        </form>
    </div>
</div>

<script src="/static/js/api.js"></script>
<script>
    let currentSaleId = null;

    async function loadSales() {
        try {
            const sales = await API.sales.getAll({ limit: 50 });
            displaySales(sales);
        } catch (error) {
            console.error('Error loading sales:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    }

    function displaySales(sales) {
        const tbody = document.getElementById('salesTable');

        if (!sales || sales.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        tbody.innerHTML = sales.map(s => `
                <tr>
                    <td>${s.contract_number || '-'}</td>
                    <td>${formatDate(s.sale_date)}</td>
                    <td>${s.model_name || '-'}</td>
                    <td>${s.client_name || '-'}</td>
                    <td>${s.manager_name || '-'}</td>
                    <td>${formatCurrency(s.base_price)}</td>
                    <td>${formatCurrency(s.discount_amount)}</td>
                    <td><strong>${formatCurrency(s.final_price)}</strong></td>
                    <td><span class="badge badge-${getStatusColor(s.status)}">${s.status}</span></td>
                    <td>
                        <button onclick="viewSale(${s.sale_id})" class="btn-icon">üëÅÔ∏è</button>
                        <button onclick="viewHistory(${s.sale_id})" class="btn-icon">üìú</button>
                    </td>
                </tr>
            `).join('');
    }

    async function loadFormData() {
        try {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
            const vehicles = await API.vehicles.getAll({ status: '–í –Ω–∞–ª–∏—á–∏–∏', limit: 100 });
            const vehicleSelect = document.getElementById('vehicleId');
            vehicleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É</option>' +
                vehicles.map(v => `<option value="${v.vehicle_id}">${v.model_name} - ${formatCurrency(v.price)}</option>`).join('');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
            const customers = await API.customers.getAll({ limit: 100 });
            const customerSelect = document.getElementById('customerId');
            customerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>' +
                customers.map(c => `<option value="${c.customer_id}">${c.last_name} ${c.first_name}</option>`).join('');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
            const corporate = await API.corporateClients.getAll({ limit: 100 });
            const corporateSelect = document.getElementById('corporateClientId');
            corporateSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é</option>' +
                corporate.map(c => `<option value="${c.corporate_client_id}">${c.company_name}</option>`).join('');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
            const employees = await API.employees.getAll({ limit: 100 });
            const employeeSelect = document.getElementById('employeeId');
            employeeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>' +
                employees.map(e => `<option value="${e.employee_id}">${e.full_name}</option>`).join('');
        } catch (error) {
            console.error('Error loading form data:', error);
        }
    }

    function toggleClientFields() {
        const type = document.getElementById('clientType').value;
        document.getElementById('customerField').style.display = type === 'customer' ? 'block' : 'none';
        document.getElementById('corporateField').style.display = type === 'corporate' ? 'block' : 'none';
    }

    function openCreateModal() {
        currentSaleId = null;
        document.getElementById('saleForm').reset();
        document.getElementById('saleModal').classList.add('active');
        loadFormData();
        toggleClientFields();
    }

    async function saveSale(event) {
        event.preventDefault();

        const clientType = document.getElementById('clientType').value;
        const data = {
            vehicle_id: parseInt(document.getElementById('vehicleId').value),
            employee_id: parseInt(document.getElementById('employeeId').value),
            payment_type: document.getElementById('paymentType').value,
            additional_discount: parseFloat(document.getElementById('additionalDiscount').value),
            notes: document.getElementById('notes').value,
        };

        if (clientType === 'customer') {
            data.customer_id = parseInt(document.getElementById('customerId').value);
        } else {
            data.corporate_client_id = parseInt(document.getElementById('corporateClientId').value);
        }

        try {
            await API.sales.create(data);
            closeModal();
            loadSales();
            alert('–ü—Ä–æ–¥–∞–∂–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!');
        } catch (error) {
            console.error('Error creating sale:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏');
        }
    }

    async function viewSale(id) {
        try {
            const sale = await API.sales.getById(id);
            alert(`–ü—Ä–æ–¥–∞–∂–∞ #${sale.sale_id}\n\n${JSON.stringify(sale, null, 2)}`);
        } catch (error) {
            console.error('Error loading sale:', error);
        }
    }

    async function viewHistory(id) {
        try {
            const history = await API.sales.getHistory(id);
            console.log('History:', history);
            alert(`–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–¥–∞–∂–∏ #${id}\n\n–°–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
        } catch (error) {
            console.error('Error loading history:', error);
        }
    }

    function filterSales() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = document.getElementById('filterStatus').value;
        // TODO: Implement filtering
        console.log('Filter:', { startDate, endDate, status });
    }

    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('filterStatus').value = '';
        loadSales();
    }

    function closeModal() {
        document.getElementById('saleModal').classList.remove('active');
    }

    function getStatusColor(status) {
        const colors = {
            '–ó–∞–≤–µ—Ä—à–µ–Ω–∞': 'success',
            '–í –ø—Ä–æ—Ü–µ—Å—Å–µ': 'warning',
            '–û—Ç–º–µ–Ω–µ–Ω–∞': 'danger',
        };
        return colors[status] || 'secondary';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('ru-BY', {
            minimumFractionDigits: 2
        }).format(value) + ' BYN';
    }

    function formatDate(date) {
        return new Date(date).toLocaleDateString('ru-BY');
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', loadSales);
</script>
</body>
</html>