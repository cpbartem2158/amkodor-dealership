<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç—ã - –ê–º–∫–æ–¥–æ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1f2937;
        }

        /* Admin Layout Styles */
        .admin-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .admin-navbar {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-toggle span {
            width: 25px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .admin-logo {
            color: white;
            text-decoration: none;
        }

        .admin-logo h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar {
            background: #1f2937;
            color: white;
            width: 250px;
            min-height: calc(100vh - 80px);
            position: fixed;
            left: -250px;
            top: 80px;
            transition: left 0.3s ease;
            z-index: 1000;
        }

        .sidebar.open {
            left: 0;
        }

        .admin-content {
            flex: 1;
            padding: 2rem;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í—ã–π—Ç–∏" */
        .btn-logout {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-logout:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-logout:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .admin-content.sidebar-open {
            margin-left: 250px;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: #d1d5db;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #374151;
            color: white;
        }

        .menu-item.active {
            background: #1d4ed8;
            color: white;
            border-left-color: #60a5fa;
        }

        .menu-icon {
            font-size: 1.25rem;
        }

        .menu-text {
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                left: -100%;
            }

            .sidebar.open {
                left: 0;
            }
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: #1f2937;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .report-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .report-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .report-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Navigation -->
        <nav class="admin-navbar">
            <div class="navbar-left">
                <button class="menu-toggle" id="menuToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="/admin/dashboard" class="admin-logo">
                    <h1>–ê–ú–ö–û–î–û–†</h1>
                </a>
            </div>

            <div class="navbar-right">
                <div class="user-info">
                    <span>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                    <button class="btn-logout" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
    <aside class="sidebar">
            <nav class="sidebar-menu">
                <a href="/admin/dashboard" class="menu-item">
                    <span class="menu-icon">üìä</span>
                    <span class="menu-text">–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
                <a href="/admin/vehicles" class="menu-item">
                    <span class="menu-icon">üöú</span>
                    <span class="menu-text">–¢–µ—Ö–Ω–∏–∫–∞</span>
                </a>
                <a href="/admin/sales" class="menu-item">
                    <span class="menu-icon">üí∞</span>
                    <span class="menu-text">–ü—Ä–æ–¥–∞–∂–∏</span>
                </a>
                <a href="/admin/customers" class="menu-item">
                    <span class="menu-icon">üë•</span>
                    <span class="menu-text">–ö–ª–∏–µ–Ω—Ç—ã</span>
                </a>
                <a href="/admin/employees" class="menu-item">
                    <span class="menu-icon">üëî</span>
                    <span class="menu-text">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                </a>
                <a href="/admin/warehouses" class="menu-item">
                    <span class="menu-icon">üè¢</span>
                    <span class="menu-text">–°–∫–ª–∞–¥—ã</span>
                </a>
                <a href="/admin/service" class="menu-item">
                    <span class="menu-icon">üîß</span>
                    <span class="menu-text">–°–µ—Ä–≤–∏—Å</span>
                </a>
                <a href="/admin/reports" class="menu-item active">
                    <span class="menu-icon">üìà</span>
                    <span class="menu-text">–û—Ç—á—ë—Ç—ã</span>
                </a>
                <a href="/admin/settings" class="menu-item">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span class="menu-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </nav>
    </aside>

        <!-- Main Content -->
        <main class="admin-content">
        <h1 class="page-title">–û—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
        
        <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç—á–µ—Ç–∞ -->
        <div id="report-settings" style="display: none; background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="margin-bottom: 1.5rem; color: #1f2937;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞</h2>
            <form id="report-form">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ü–µ—Ä–∏–æ–¥ —Å:</label>
                        <input type="date" id="date-from" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ü–µ—Ä–∏–æ–¥ –ø–æ:</label>
                        <input type="date" id="date-to" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                        </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</label>
                        <select id="file-format" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                        </select>
                        </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">–ü—É—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:</label>
                        <input type="text" id="save-path" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è" readonly style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; background: #f9fafb;">
                        <button type="button" onclick="selectSavePath()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="hideReportSettings()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 0.5rem; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                </div>
            </form>
        </div>

        <div class="reports-grid">
            <div class="report-card">
                <div class="report-icon">üí∞</div>
                <div class="report-title">–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</div>
                <div class="report-description">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                <button class="btn btn-primary" onclick="showReportSettings('sales')">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>

            <div class="report-card">
                <div class="report-icon">üöú</div>
                <div class="report-title">–û—Ç—á–µ—Ç –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ</div>
                <div class="report-description">–ê–Ω–∞–ª–∏–∑ –Ω–∞–ª–∏—á–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–∏</div>
                <button class="btn btn-primary" onclick="showReportSettings('vehicles')">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>

            <div class="report-card">
                <div class="report-icon">üë•</div>
                <div class="report-title">–û—Ç—á–µ—Ç –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</div>
                <div class="report-description">–ê–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                <button class="btn btn-primary" onclick="showReportSettings('customers')">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>

            <div class="report-card">
                <div class="report-icon">üìä</div>
                <div class="report-title">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç</div>
                <div class="report-description">–ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
                <button class="btn btn-primary" onclick="showReportSettings('financial')">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
</div>

<script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentReportType = '';
        let saveDirHandle = null; // –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏ (File System Access API)
        let reportSettingsTemplate = '';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
            return;
        }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('date-from').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞
            const reportSettings = document.getElementById('report-settings');
            reportSettingsTemplate = reportSettings.innerHTML;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –æ—Ç—á–µ—Ç–∞
            const form = document.getElementById('report-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    generateReport();
                });
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞
        function showReportSettings(reportType) {
            currentReportType = reportType;
            document.getElementById('report-settings').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
            const titles = {
                'sales': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º',
                'vehicles': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ',
                'customers': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º',
                'financial': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞'
            };
            
            document.querySelector('#report-settings h2').textContent = titles[reportType] || '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞';
        }

        // –°–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–∞
        function hideReportSettings() {
            const rs = document.getElementById('report-settings');
            rs.style.display = 'none';
            const form = document.getElementById('report-form');
            if (form) form.reset();
        }

        // –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º File System Access API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        async function selectSavePath() {
            const input = document.getElementById('save-path');
            if (window.showDirectoryPicker) {
                try {
                    saveDirHandle = await window.showDirectoryPicker();
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ –∏–º—è, –ø—É—Ç—å –±—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–¥–∞—ë—Ç –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    input.value = `–ü–∞–ø–∫–∞: ${saveDirHandle.name}`;
                } catch (e) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä
                }
            } else {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–∞–ø–∫–∏. –§–∞–π–ª –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                input.value = '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ)';
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        async function generateReport() {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const fileFormat = document.getElementById('file-format').value;
            const reqFormat = fileFormat === 'excel' ? 'xlsx' : fileFormat; // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–ª—è –±—ç–∫–µ–Ω–¥–∞
            const savePath = document.getElementById('save-path').value;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const reportSettings = document.getElementById('report-settings');
            reportSettings.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                    <h2 style="margin-bottom: 1rem; color: #1f2937;">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</h2>
                    <p style="color: #6b7280;">–°–æ–∑–¥–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏</p>
                </div>
            `;

            try {
                const url = `/api/reports/export?type=${encodeURIComponent(currentReportType)}&format=${encodeURIComponent(fileFormat)}&start_date=${encodeURIComponent(dateFrom)}&end_date=${encodeURIComponent(dateTo)}`;
                const res = await fetch(url, { method: 'GET' });
                if (!res.ok) throw new Error('export failed');
                const blob = await res.blob();

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∞; –∏–Ω–∞—á–µ ‚Äî —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                const cd = res.headers.get('Content-Disposition') || '';
                const match = cd.match(/filename=([^;]+)/);
                const fallbackName = match ? match[1] : `report_${currentReportType}_${dateFrom}_${dateTo}.${fileFormat}`;

                if (window.showDirectoryPicker && saveDirHandle && saveDirHandle.getFileHandle) {
                    try {
                        const fileHandle = await saveDirHandle.getFileHandle(fallbackName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                    } catch (e) {
                        triggerDownload(blob, fallbackName);
                    }
                } else {
                    triggerDownload(blob, fallbackName);
                }

                // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                const reportSettings = document.getElementById('report-settings');
                reportSettings.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style=\"font-size: 3rem; margin-bottom: 1rem; color: #059669;\">‚úÖ</div>
                        <h2 style=\"margin-bottom: 1rem; color: #1f2937;\">–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!</h2>
                        <p style=\"color: #6b7280; margin-bottom: 1rem;\">${saveDirHandle ? `–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${saveDirHandle.name}` : '–§–∞–π–ª —Å–∫–∞—á–∞–Ω –≤ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫'}</p>
                        <p style=\"background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; font-family: monospace; word-break: break-all;\">${fallbackName}</p>
                        <div style=\"margin-top: 2rem;\">
                            <button onclick=\"hideReportSettings()\" style=\"padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;\">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button onclick=\"generateAnotherReport()\" style=\"padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 0.5rem; cursor: pointer;\">–°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω</button>
                        </div>
                    </div>
                `;
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞');
                showReportSettings(currentReportType);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Excel –æ—Ç—á–µ—Ç–∞
        async function createExcelReport(dateFrom, dateTo, fileFormat, savePath) {
            const reportNames = {
                'sales': '–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º',
                'vehicles': '–û—Ç—á–µ—Ç –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ',
                'customers': '–û—Ç—á–µ—Ç –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º',
                'financial': '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç'
            };

            // –§–∞–π–ª–æ—Ñ–æ—Ä–º–∞—Ç: –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ "Excel" —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π CSV (–∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Excel)
            const ext = fileFormat === 'excel' ? 'csv' : (fileFormat === 'pdf' ? 'pdf' : 'csv');
            const mime = ext === 'csv' ? 'text/csv;charset=utf-8;' : 'application/pdf';
            const fileName = `${reportNames[currentReportType]}_${dateFrom}_${dateTo}.${ext}`;
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±—ç–∫–µ–Ω–¥–∞ –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª –Ω—É–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
            const resp = await fetch('/api/reports/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: currentReportType,
                    format: fileFormat,
                    date_from: dateFrom,
                    date_to: dateTo
                })
            });

            if (!resp.ok) {
                alert('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞');
            return;
        }

            const blob = await resp.blob();

            // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–ø–∫—É, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            if (saveDirHandle && saveDirHandle.getFileHandle) {
                try {
                    const fileHandle = await saveDirHandle.getFileHandle(fileName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                } catch (e) {
                    triggerDownload(blob, fileName);
                }
            } else {
                triggerDownload(blob, fileName);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const reportSettings = document.getElementById('report-settings');
            reportSettings.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: #059669;">‚úÖ</div>
                    <h2 style="margin-bottom: 1rem; color: #1f2937;">–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!</h2>
                    <p style="color: #6b7280; margin-bottom: 1rem;">${saveDirHandle ? `–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ: ${saveDirHandle.name}` : '–§–∞–π–ª —Å–∫–∞—á–∞–Ω –≤ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫'}</p>
                    <p style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; font-family: monospace; word-break: break-all;">${fileName}</p>
                    <div style="margin-top: 2rem;">
                        <button onclick="hideReportSettings()" style="padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem; cursor: pointer; margin-right: 1rem;">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button onclick="generateAnotherReport()" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω</button>
                    </div>
                </div>
            `;
        }

        function triggerDownload(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ CSV –æ—Ç—á–µ—Ç–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
        function createSalesReportCSV() {
            return `ID,–ö–ª–∏–µ–Ω—Ç,–¢–µ—Ö–Ω–∏–∫–∞,–°—É–º–º–∞,–î–∞—Ç–∞,–°—Ç–∞—Ç—É—Å
1,–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤,–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä –ê–ú–ö–û–î–û–† 331.04,450000,2025-10-01,–ó–∞–≤–µ—Ä—à–µ–Ω–∞
2,–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞,–ë—É–ª—å–¥–æ–∑–µ—Ä –ê–ú–ö–û–î–û–† 342.04,380000,2025-10-02,–í –ø—Ä–æ—Ü–µ—Å—Å–µ
3,–û–û–û –°—Ç—Ä–æ–π—Ç–µ—Ö–Ω–∏–∫–∞,–ü–æ–≥—Ä—É–∑—á–∏–∫ –ê–ú–ö–û–î–û–† 352.04,320000,2025-10-03,–ó–∞–≤–µ—Ä—à–µ–Ω–∞
4,–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–æ–∑–ª–æ–≤,–¢—Ä–∞–∫—Ç–æ—Ä –ú–¢–ó-82.1,280000,2025-10-04,–ó–∞–≤–µ—Ä—à–µ–Ω–∞
5,–ï–ª–µ–Ω–∞ –ù–æ–≤–∏–∫–æ–≤–∞,–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä –ê–ú–ö–û–î–û–† 331.05,520000,2025-10-05,–í –ø—Ä–æ—Ü–µ—Å—Å–µ`;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ CSV –æ—Ç—á–µ—Ç–∞ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ
        function createVehiclesReportCSV() {
            return `ID,–ù–∞–∑–≤–∞–Ω–∏–µ,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–¶–µ–Ω–∞,–°—Ç–∞—Ç—É—Å,–ì–æ–¥,–î–≤–∏–≥–∞—Ç–µ–ª—å,–ú–æ—â–Ω–æ—Å—Ç—å,–í–µ—Å
1,–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä –ê–ú–ö–û–î–û–† 331.04,–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä—ã,450000,–í –Ω–∞–ª–∏—á–∏–∏,2023,–Ø–ú–ó-238,180 –ª.—Å.,14.5 —Ç
2,–ë—É–ª—å–¥–æ–∑–µ—Ä –ê–ú–ö–û–î–û–† 342.04,–ë—É–ª—å–¥–æ–∑–µ—Ä—ã,380000,–í –Ω–∞–ª–∏—á–∏–∏,2023,–Ø–ú–ó-238,180 –ª.—Å.,16.2 —Ç
3,–ü–æ–≥—Ä—É–∑—á–∏–∫ –ê–ú–ö–û–î–û–† 352.04,–ü–æ–≥—Ä—É–∑—á–∏–∫–∏,320000,–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ,2023,–Ø–ú–ó-238,180 –ª.—Å.,12.8 —Ç
4,–¢—Ä–∞–∫—Ç–æ—Ä –ú–¢–ó-82.1,–¢—Ä–∞–∫—Ç–æ—Ä—ã,280000,–í –Ω–∞–ª–∏—á–∏–∏,2023,–î-240,82 –ª.—Å.,3.6 —Ç
5,–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä –ê–ú–ö–û–î–û–† 331.05,–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä—ã,520000,–í –Ω–∞–ª–∏—á–∏–∏,2024,–Ø–ú–ó-238,200 –ª.—Å.,15.8 —Ç`;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ CSV –æ—Ç—á–µ—Ç–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
        function createCustomersReportCSV() {
            return `ID,–ù–∞–∑–≤–∞–Ω–∏–µ,–¢–∏–ø,Email,–¢–µ–ª–µ—Ñ–æ–Ω,–ê–¥—Ä–µ—Å,–°—Ç–∞—Ç—É—Å
1,–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤,–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ,ivan.petrov@email.com,+375 29 123-45-67,–≥. –ú–∏–Ω—Å–∫ —É–ª. –õ–µ–Ω–∏–Ω–∞ 1,–ê–∫—Ç–∏–≤–Ω—ã–π
2,–û–û–û –°—Ç—Ä–æ–π—Ç–µ—Ö–Ω–∏–∫–∞,–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ,info@stroytech.by,+375 17 234-56-78,–≥. –ú–∏–Ω—Å–∫ –ø—Ä. –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ 25,VIP
3,–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞,–ò–ü,maria.sidorova@email.com,+375 29 345-67-89,–≥. –ì–æ–º–µ–ª—å —É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è 10,–ê–∫—Ç–∏–≤–Ω—ã–π
4,–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–æ–∑–ª–æ–≤,–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ,alex.kozlov@email.com,+375 29 456-78-90,–≥. –í–∏—Ç–µ–±—Å–∫ —É–ª. –ü—É—à–∫–∏–Ω–∞ 5,–ê–∫—Ç–∏–≤–Ω—ã–π
5,–ï–ª–µ–Ω–∞ –ù–æ–≤–∏–∫–æ–≤–∞,–ò–ü,elena.novikova@email.com,+375 29 567-89-01,–≥. –ú–æ–≥–∏–ª–µ–≤ —É–ª. –õ–µ–Ω–∏–Ω–∞ 15,–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π`;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ CSV —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        function createFinancialReportCSV() {
            return `–ü–µ—Ä–∏–æ–¥,–î–æ—Ö–æ–¥—ã,–†–∞—Å—Ö–æ–¥—ã,–ü—Ä–∏–±—ã–ª—å,–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂
2025-10-01,450000,50000,400000,1
2025-10-02,380000,45000,335000,1
2025-10-03,320000,40000,280000,1
2025-10-04,280000,35000,245000,1
2025-10-05,520000,60000,460000,1
–ò—Ç–æ–≥–æ,1950000,230000,1720000,5`;
        }

        // –°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –æ—Ç—á–µ—Ç
        function generateAnotherReport() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const rs = document.getElementById('report-settings');
            rs.innerHTML = reportSettingsTemplate;
            rs.style.display = 'block';

            // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏
            saveDirHandle = null;
            const input = document.getElementById('save-path');
            if (input) input.value = '';

            // –ü–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ submit
            const form = document.getElementById('report-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    generateReport();
                });
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            const fromEl = document.getElementById('date-from');
            const toEl = document.getElementById('date-to');
            if (fromEl && toEl) {
                fromEl.value = oneMonthAgo.toISOString().split('T')[0];
                toEl.value = today.toISOString().split('T')[0];
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –æ—Ç—á—ë—Ç–∞
            showReportSettings(currentReportType);
        }

        // –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É —Å –æ—Ç—á–µ—Ç–æ–º
        function openReportFolder(path) {
            alert(`–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–ø–∫–∏: ${path}\n\n–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—É—Å–∫ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.`);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const adminContent = document.querySelector('.admin-content');

            if (menuToggle && sidebar && adminContent) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('open');
                    adminContent.classList.toggle('sidebar-open');
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', function(e) {
                    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                        sidebar.classList.remove('open');
                        adminContent.classList.remove('sidebar-open');
                    }
                });

                // Auto-close sidebar when clicking menu items
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.addEventListener('click', function() {
                        sidebar.classList.remove('open');
                        adminContent.classList.remove('sidebar-open');
                    });
                });
            }
        });
    </script>
        </main>
    </div>
</body>
</html>